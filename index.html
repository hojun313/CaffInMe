<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaffInMe - 내 몸속 카페인 트래커</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.0.1/chartjs-plugin-annotation.min.js" integrity="sha512-H0yQ4XPAtyd3GNBbD2JoLv2fbI/gB3HAJ3sM+c7GMEeTTKIIO495TU/2S7bPAw+d3w3sK/L5U5jV+NMc9T5KdA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-brown: #4E342E;
            --point-beige: #F5E6CC;
            --accent-orange: #FB923C;
            --warning-red: #B91C1C;
            --bg-sand: #FAFAF9;
            --text-deep-brown: #1C1917;
        }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-sand); color: var(--text-deep-brown); margin: 0; }
        .hidden { display: none !important; }

        /* --- Setup Screen --- */
        #setup-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100vh; text-align: center; }
        #setup-screen h2 { font-size: 28px; color: var(--main-brown); }
        .setup-options button { display: block; width: 300px; padding: 15px; margin: 10px 0; font-size: 18px; font-weight: 700; border: 2px solid var(--point-beige); border-radius: 8px; background-color: white; color: var(--text-deep-brown); cursor: pointer; transition: all 0.2s ease; }
        .setup-options button:hover { background-color: var(--point-beige); border-color: var(--main-brown); }

        /* --- Main Tracker --- */
        #main-tracker { display: flex; flex-direction: column; height: 100vh; }
        .container { display: flex; justify-content: center; align-items: center; position: relative; padding: 20px; }
        .container h1 { margin: 0; font-size: 42px; color: var(--main-brown); text-align: center; }
        .top-panel { display: flex; flex: 1; gap: 20px; padding: 0 20px 20px; }
        .panel { position: relative; flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; background-color: #FFFFFF; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); padding: 20px; }
        .controls-panel { display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(3, 1fr); gap: 15px; }
        #add-2shots { grid-row: 1 / 3; grid-column: 1 / 2; }
        #add-1shot { grid-row: 1 / 2; grid-column: 2 / 3; }
        #add-4shots { grid-row: 2 / 3; grid-column: 2 / 3; }
        #add-past-btn { grid-row: 3 / 4; grid-column: 1 / 3; background-color: var(--main-brown); color: white; }
        .graph-panel { flex: 2; margin: 0 20px 20px 20px; background-color: #FFFFFF; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); padding: 20px; }
        #caffeine-status h1 { font-size: 24px; font-weight: 700; color: var(--main-brown); }
        #caffeine-level { font-size: 48px; font-weight: 700; color: var(--accent-orange); margin: 0; }
        #caffeine-status { text-align: center; margin-bottom: 15px; }
        #history-btn { width: 100%; padding: 8px 12px; font-size: 14px; font-weight: 700; border: 1px solid var(--point-beige); border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; background-color: #fff; color: var(--text-deep-brown); }
        #history-btn:hover { background-color: var(--point-beige); }
        .controls-panel button { width: 100%; height: 100%; padding: 15px 20px; margin: 0; font-size: 16px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; background-color: var(--point-beige); color: var(--text-deep-brown); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .controls-panel button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        #reset-btn { position: absolute; bottom: 15px; right: 15px; width: 32px; height: 32px; padding: 0; background-color: transparent; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; }
        #reset-btn svg { fill: #aaa; transition: fill 0.2s ease; }
        #reset-btn:hover { background-color: #f0f0f0; }
        #reset-btn:hover svg { fill: #555; }
        #help-btn { position: absolute; right: 25px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; padding: 0; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; color: #888; transition: all 0.2s ease; }
        #help-btn:hover { background-color: #e0e0e0; }

        /* --- Modal Styles --- */
        .modal { position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 12px; position: relative; line-height: 1.6; }
        .modal-content h2 { margin-top: 0; color: var(--main-brown); }
        .modal-content h3 { color: var(--main-brown); border-bottom: 2px solid var(--point-beige); padding-bottom: 5px; margin-top: 20px; }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
        #past-entry-modal .modal-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        #past-entry-modal .modal-controls button { flex: 1; padding: 10px; font-size: 14px; border: 2px solid transparent; }
        #past-entry-modal input[type="datetime-local"] { width: 100%; padding: 8px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px; }
        #past-entry-modal .save-btn { background-color: var(--accent-orange); color: white; width: 100%; padding: 12px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; }
        
        #history-modal .history-list { list-style: none; padding: 0; margin-top: 20px; max-height: 300px; overflow-y: auto; }
        #history-modal .history-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        #history-modal .history-list li:last-child { border-bottom: none; }
        #history-modal .history-list .amount { font-weight: bold; color: var(--accent-orange); }
        #history-modal .history-list .time { font-size: 14px; color: #555; }
        #history-modal .history-list .delete-log-btn { background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold; line-height: 24px; text-align: center; }
        #history-modal .empty-history { text-align: center; color: #888; padding: 20px; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h2>평소에 카페인 음료를 얼마나 자주 드시나요?</h2>
        <div class="setup-options">
            <button data-amount="0">전혀 마시지 않아요</button>
            <button data-amount="10">가끔 생각날 때만 마셔요</button>
            <button data-amount="30">일주일에 1~2번 정도 마셔요</button>
            <button data-amount="50">일주일에 3~5번 정도 마셔요</button>
            <button data-amount="70">거의 매일 마셔요</button>
        </div>
    </div>

    <div id="main-tracker" class="hidden">
        <div class="container">
            <h1>CaffInMe</h1>
            <button id="help-btn" title="도움말">?</button>
        </div>
        <div class="top-panel">
            <div class="panel status-panel">
                <div id="caffeine-status">
                    <h1>현재 체내 카페인</h1>
                    <p id="caffeine-level">-- mg</p>
                </div>
                <button id="history-btn">섭취 기록 보기</button>
                <button id="reset-btn" title="초기화"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></button>
            </div>
            <div class="panel controls-panel">
                <button id="add-2shots">2샷 추가 (150mg)</button>
                <button id="add-1shot">1샷 추가 (75mg)</button>
                <button id="add-4shots">4샷 추가 (300mg)</button>
                <button id="add-past-btn">과거 기록 추가</button>
            </div>
        </div>
        <div class="graph-panel"><canvas id="caffeine-chart"></canvas></div>
    </div>

    <div id="help-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" id="close-help-btn">&times;</span>
            <h2>도움말</h2>
            <h3>카페인 반감기란?</h3>
            <p>카페인 반감기는 우리 몸이 섭취한 카페인의 양을 절반으로 줄이는 데 걸리는 시간을 의미합니다. 일반적으로 성인의 경우 약 5시간 정도 소요됩니다. 저희 앱은 이 원리를 사용하여 시간에 따른 체내 카페인 양을 추정합니다.</p>
            <h3>숙면을 위한 50mg</h3>
            <p>개인차가 있지만, 보통 체내 카페인이 50mg 이하일 때 수면에 큰 영향을 주지 않는 '안전 구간'으로 봅니다. 그래프의 녹색 영역은 이 50mg 이하 구간을 나타내며, 편안한 잠을 자기 좋은 상태를 의미합니다.</p>
        </div>
    </div>

    <div id="past-entry-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" id="close-past-entry-btn">&times;</span>
            <h2>과거 기록 추가</h2>
            <h3>섭취량</h3>
            <div class="modal-controls">
                <button data-amount="75">1샷 (75mg)</button>
                <button data-amount="150">2샷 (150mg)</button>
                <button data-amount="300">4샷 (300mg)</button>
            </div>
            <h3>섭취 시간</h3>
            <input type="datetime-local" id="past-time-input">
            <button class="save-btn" id="save-past-entry-btn">저장하기</button>
        </div>
    </div>

    <div id="history-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" id="close-history-btn">&times;</span>
            <h2>카페인 섭취 기록</h2>
            <ul id="history-list" class="history-list"></ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const setupScreen = document.getElementById('setup-screen');
            const mainTracker = document.getElementById('main-tracker');
            const setupOptions = document.querySelector('.setup-options');
            const caffeineLevelEl = document.getElementById('caffeine-level');
            const add1ShotBtn = document.getElementById('add-1shot');
            const add2ShotsBtn = document.getElementById('add-2shots');
            const add4ShotsBtn = document.getElementById('add-4shots');
            const addPastBtn = document.getElementById('add-past-btn');
            const chartCanvas = document.getElementById('caffeine-chart');
            const resetBtn = document.getElementById('reset-btn');
            const helpBtn = document.getElementById('help-btn');
            const historyBtn = document.getElementById('history-btn');

            const helpModal = document.getElementById('help-modal');
            const closeHelpBtn = document.getElementById('close-help-btn');
            
            const pastEntryModal = document.getElementById('past-entry-modal');
            const closePastEntryBtn = document.getElementById('close-past-entry-btn');
            const pastTimeInput = document.getElementById('past-time-input');
            const savePastEntryBtn = document.getElementById('save-past-entry-btn');
            const pastEntryAmountBtns = pastEntryModal.querySelector('.modal-controls');

            const historyModal = document.getElementById('history-modal');
            const closeHistoryBtn = document.getElementById('close-history-btn');
            const historyListEl = document.getElementById('history-list');

            // --- Constants ---
            const LOG_KEY = 'caffeineLog';
            const SETUP_KEY = 'caffInMe_setupComplete';
            const HALF_LIFE_MS = 5 * 60 * 60 * 1000;

            let caffeineChart = null;
            let selectedPastAmount = 0;

            // --- Data Layer ---
            const getLog = () => JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
            const saveLog = (log) => {
                log.sort((a, b) => a.timestamp - b.timestamp);
                localStorage.setItem(LOG_KEY, JSON.stringify(log));
            };

            // --- Business Logic ---
            const calculateCaffeineAtTime = (log, time) => {
                let totalCaffeine = 0;
                log.forEach(entry => {
                    const timeElapsed = time - entry.timestamp;
                    if (timeElapsed >= 0) {
                        totalCaffeine += entry.amount * Math.pow(0.5, timeElapsed / HALF_LIFE_MS);
                    }
                });
                return totalCaffeine;
            };

            const formatTimestamp = (timestamp) => {
                const date = new Date(timestamp);
                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();
                const isYesterday = new Date(now.setDate(now.getDate() - 1)).toDateString() === date.toDateString();

                const timeString = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: true });

                if (isToday) return `오늘 ${timeString}`;
                if (isYesterday) return `어제 ${timeString}`;
                
                return `${date.toLocaleDateString('ko-KR')} ${timeString}`;
            };

            // --- Presentation Layer ---
            const updateCaffeineDisplay = () => {
                const log = getLog();
                const currentLevel = calculateCaffeineAtTime(log, Date.now());
                caffeineLevelEl.textContent = `${Math.round(currentLevel)} mg`;
            };

            const renderChart = () => {
                const log = getLog();
                const now = Date.now();
                const labels = [];
                const dataPoints = [];

                for (let i = -12; i <= 12; i += 0.5) {
                    const time = now + i * 60 * 60 * 1000;
                    if (i === 0) { labels.push('Now'); } 
                    else { labels.push(`${i > 0 ? '+' : ''}${i}h`); }
                    dataPoints.push(calculateCaffeineAtTime(log, time));
                }

                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: '체내 카페인 농도 (mg)',
                        data: dataPoints,
                        borderColor: '#FB923C',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHitRadius: 10,
                        backgroundColor: function(context) {
                            const {ctx, chartArea, scales} = context.chart;
                            if (!chartArea) return null;
                            const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                            const y50 = scales.y.getPixelForValue(50);
                            const stop = Math.max(0, Math.min(1, (y50 - chartArea.top) / chartArea.height));
                            const highColor = 'rgba(251, 146, 60, 0.2)';
                            const lowColor = 'rgba(72, 187, 120, 0.2)';
                            if (scales.y.max <= 50) {
                                 gradient.addColorStop(0, lowColor); gradient.addColorStop(1, lowColor);
                            } else if (scales.y.min >= 50) {
                                 gradient.addColorStop(0, highColor); gradient.addColorStop(1, highColor);
                            } else {
                                gradient.addColorStop(0, highColor); gradient.addColorStop(stop, highColor);
                                gradient.addColorStop(stop, lowColor); gradient.addColorStop(1, lowColor);
                            }
                            return gradient;
                        },
                    }]
                };

                if (caffeineChart) {
                    caffeineChart.data = chartData;
                    caffeineChart.update('none');
                } else {
                    const ctx = chartCanvas.getContext('2d');
                    caffeineChart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, ticks: { color: '#1C1917' }, grid: { color: 'rgba(0,0,0,0.05)' } },
                                      x: { ticks: { color: '#1C1917' }, grid: { display: false } } },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            };

            const renderHistoryList = () => {
                const log = getLog();
                historyListEl.innerHTML = ''; // Clear previous list

                if (log.length === 0) {
                    historyListEl.innerHTML = '<li class="empty-history">섭취 기록이 없습니다.</li>';
                    return;
                }

                log.slice().reverse().forEach(entry => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div>
                            <span class="amount">${entry.amount} mg</span>
                            <span class="time">${formatTimestamp(entry.timestamp)}</span>
                        </div>
                        <button class="delete-log-btn" data-timestamp="${entry.timestamp}">&times;</button>
                    `;
                    historyListEl.appendChild(li);
                });
            };

            // --- App Logic ---
            const updateAll = () => { updateCaffeineDisplay(); renderChart(); };

            const addCaffeine = (amount, timestamp) => {
                const log = getLog();
                log.push({ timestamp: timestamp, amount: amount });
                const twentyFourHoursAgo = Date.now() - 24 * 60 * 60 * 1000;
                const cleanedLog = log.filter(entry => entry.timestamp > twentyFourHoursAgo);
                saveLog(cleanedLog);
                updateAll();
            };

            const startApp = () => {
                mainTracker.classList.remove('hidden');
                setupScreen.classList.add('hidden');
                updateAll();
                setInterval(updateAll, 60000);
            };

            // --- Initialization ---
            add1ShotBtn.addEventListener('click', () => addCaffeine(75, Date.now()));
            add2ShotsBtn.addEventListener('click', () => addCaffeine(150, Date.now()));
            add4ShotsBtn.addEventListener('click', () => addCaffeine(300, Date.now()));

            resetBtn.addEventListener('click', () => {
                if (confirm('모든 기록을 삭제하고 초기 설정 화면으로 돌아가시겠습니까?')) {
                    localStorage.removeItem(LOG_KEY);
                    localStorage.removeItem(SETUP_KEY);
                    window.location.reload();
                }
            });

            // --- Modal Event Listeners ---
            helpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
            closeHelpBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) { helpModal.classList.add('hidden'); }
            });

            addPastBtn.addEventListener('click', () => {
                pastEntryModal.classList.remove('hidden');
                pastTimeInput.value = new Date(Date.now() - 3600 * 1000).toISOString().slice(0, 16);
                selectedPastAmount = 0;
                [...pastEntryAmountBtns.children].forEach(btn => btn.style.border = '2px solid transparent');
            });
            closePastEntryBtn.addEventListener('click', () => pastEntryModal.classList.add('hidden'));
            pastEntryModal.addEventListener('click', (e) => {
                if (e.target === pastEntryModal) { pastEntryModal.classList.add('hidden'); }
            });
            
            pastEntryAmountBtns.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    selectedPastAmount = parseFloat(e.target.dataset.amount);
                    [...pastEntryAmountBtns.children].forEach(btn => btn.style.border = '2px solid transparent');
                    e.target.style.border = '2px solid #FB923C';
                }
            });

            savePastEntryBtn.addEventListener('click', () => {
                const pastTime = pastTimeInput.value;
                if (selectedPastAmount === 0) {
                    alert('섭취량을 선택해주세요.');
                    return;
                }
                if (!pastTime) {
                    alert('섭취 시간을 선택해주세요.');
                    return;
                }
                const timestamp = new Date(pastTime).getTime();
                if (timestamp > Date.now()) {
                    alert('미래 시간은 선택할 수 없습니다.');
                    return;
                }
                addCaffeine(selectedPastAmount, timestamp);
                pastEntryModal.classList.add('hidden');
            });

            historyBtn.addEventListener('click', () => {
                renderHistoryList();
                historyModal.classList.remove('hidden');
            });
            closeHistoryBtn.addEventListener('click', () => historyModal.classList.add('hidden'));
            historyModal.addEventListener('click', (e) => {
                if (e.target === historyModal) { historyModal.classList.add('hidden'); }
            });

            historyListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-log-btn')) {
                    const timestamp = parseInt(e.target.dataset.timestamp, 10);
                    if (confirm('이 기록을 삭제하시겠습니까?')) {
                        let log = getLog();
                        log = log.filter(entry => entry.timestamp !== timestamp);
                        saveLog(log);
                        updateAll();
                        renderHistoryList(); // Re-render the list in the modal
                    }
                }
            });

            setupOptions.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const initialAmount = parseFloat(e.target.dataset.amount);
                    if (initialAmount > 0) {
                        addCaffeine(initialAmount, Date.now());
                    }
                    localStorage.setItem(SETUP_KEY, 'true');
                    startApp();
                }
            });

            if (localStorage.getItem(SETUP_KEY) === 'true') {
                startApp();
            } else {
                setupScreen.classList.remove('hidden');
            }
        });
    </script>

</body>
</html>
